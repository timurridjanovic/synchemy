{"version":3,"sources":["../src/server.js"],"names":["SynchemyServer","app","server","options","sockets","onMessageCallback","onSocketConnectionCallback","onSocketDisconnectionCallback","ws","WebSocket","Server","on","socket","socketId","push","data","parsedData","JSON","parse","then","message","messageId","send","stringify","_","otherSockets","Object","keys","func","Promise","resolve","reject","newMessage","Array","isArray","Error","forEach","values"],"mappings":"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","sourcesContent":["import WebSocket from 'ws'\nimport { v4 as uuid } from 'uuid'\n\nclass SynchemyServer {\n  sockets = []\n  #messagingManager = {\n    sockets: {},\n    onMessageCallback: null,\n    onSocketConnectionCallback: null,\n    onSocketDisconnectionCallback: null\n  }\n\n  constructor ({ app, server, options = {} }) {\n    const ws = new WebSocket.Server({\n      server,\n      ...options\n    })\n\n    server.on('request', app)\n\n    ws.on('connection', socket => {\n      const socketId = uuid()\n      this.#messagingManager.sockets[socketId] = socket\n      this.sockets.push(socketId)\n\n      socket.on('message', data => {\n        const parsedData = JSON.parse(data)\n        if (this.#messagingManager.onMessageCallback) {\n          this.#messagingManager.onMessageCallback(parsedData, socketId).then(({ message, messageId }) => {\n            socket.send(JSON.stringify({\n              message, messageId\n            }))\n          })\n        }\n      })\n\n      socket.on('close', () => {\n        if (this.#messagingManager) {\n          const { [socketId]: _, ...otherSockets } = this.#messagingManager.sockets\n          this.#messagingManager.sockets = otherSockets\n          this.sockets = Object.keys(otherSockets)\n          if (this.#messagingManager.onSocketDisconnectionCallback) {\n            this.#messagingManager.onSocketDisconnectionCallback(socketId)\n          }\n        }\n      })\n\n      if (this.#messagingManager.onSocketConnectionCallback) {\n        this.#messagingManager.onSocketConnectionCallback(socketId)\n      }\n    })\n  }\n\n  onSocketConnection (func) {\n    this.#messagingManager.onSocketConnectionCallback = func\n  }\n\n  onSocketDisconnection (func) {\n    this.#messagingManager.onSocketDisconnectionCallback = func\n  }\n\n  onMessage (func) {\n    this.#messagingManager.onMessageCallback = (data, socketId) => {\n      return new Promise((resolve, reject) => {\n        const { messageId, message } = data\n        const newMessage = func({ message, socketId })\n        resolve({ message: newMessage, messageId })\n      })\n    }\n  }\n\n  send (sockets = [], message) {\n    if (!Array.isArray(sockets)) {\n      throw new Error('The first param to synchemy.send must be an array of socket ids.')\n    }\n\n    sockets.forEach(socketId => {\n      const socket = this.#messagingManager.sockets[socketId]\n      if (socket && socket.send) {\n        socket.send(JSON.stringify({\n          message\n        }))\n      } else {\n        throw new Error('One of the socketIds you provided is invalid.')\n      }\n    })\n  }\n\n  sendAll (message) {\n    Object.values(this.#messagingManager.sockets).forEach(socket => {\n      socket.send(JSON.stringify({\n        message\n      }))\n    })\n  }\n}\n\nexport default SynchemyServer\n"],"file":"server.js"}